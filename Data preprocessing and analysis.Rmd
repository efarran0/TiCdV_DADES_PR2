---
title: 'Tipologia i cicle de vida de les dades: pràctica 2'
author: "Eric Farran Moreno i Jordi Alvarez Pitarque"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    number_sections: yes
    toc_depth: 3
header-includes:
  \usepackage{dcolumn}
lang: ca
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
options(scipen = 999)
```

```{r}
# Es carreguen les llibreries requerides
  if(!require(stringr)){
    install.packages('stringr')
  }
  library(stringr)

if(!require(VIM)){
    install.packages('VIM')
  }
  library(VIM)
```

\newpage

# Importació dataset

```{r}
# S'importa la data
  top250movies <- read.csv('top250movies.csv')
```

# Neteja

## Es defineixen les funcions de neteja

```{r}
# Eliminació del patró de la columna especificada
  top250movies.remove <- function(column,
                                  pattern){
    result <- str_remove_all(string = top250movies[[column]],
                             pattern = pattern)
    return(result)
  }

# Conversió de la duració a minuts
  top250movies.duration_conversion <- function(duration){
    value <- str_split(string = duration,
                       pattern = ' ')[[1]]
    if(is.na(value[2])){
      if(grepl(pattern = 'h',
               x = value[1])){
        hours <- as.numeric(str_remove_all(string = value[1],
                                           pattern = '[a-z]'))
        minutes <- 0
        }else{
          hours <- 0
          minutes <- as.numeric(str_remove_all(string = value[1],
                                           pattern = '[a-z]'))
      }
      }else{
        hours <- as.numeric(str_remove_all(string = value[1],
                                           pattern = '[a-z]'))
        minutes <- as.numeric(str_remove_all(string = value[2],
                                           pattern = '[a-z]'))
      }
    time <- hours*60 + minutes
    return(time)
  }

# Conversió dels reviews en unitats
  top250movies.review_conversion <- function(review){
    if(grepl(pattern = 'K',
             x = review)){
      units <- paste(str_remove_all(string = review,
                                    pattern = '[^0-9]'),
                     '000',
                     sep = '')
      }else{
        if(grepl(pattern = '\\.',
                 x = review)){
          units <- paste(str_remove_all(string = review,
                                        pattern = '[^0-9]'),
                         '00000',
                         sep = '')
          }else{
            units <- paste(str_remove_all(string = review,
                                          pattern = '[^0-9]'),
                           '000000',
                           sep = '')}
      }
    return(units)
  }

# Conversió del pressupost en dòlars
  top250movies.dollar_conversion <- function(monetary_units){
    if(is.na(monetary_units)){
      conversion <- NA
    }else{
    conversion_value <- subset(Monetary_conversion_policy,
                               subset = Local == str_replace_all(string = monetary_units,
                                                                 pattern = '[0-9]|\\,|\\s',
                                                                 replacement = ''),
                               select = Dolar,
                               drop = TRUE)
    value <- as.numeric(str_replace_all(string = monetary_units,
                                        pattern = '[^0-9]',
                                        replacement = ''))
    conversion <- value*conversion_value
    }
    return(conversion)
  }

# Proporció de valors perduts en la columna
  top250movies.na_prop <- function(column){
    value <- subset(x = top250movies,
                    select = column,
                    drop = TRUE)
    result <- cat(column,
               ': ',
               round(x = sum(is.na(value))/length(value),
                     digits = 3)*100,
               '%',
               '\n',
               sep = '')
    return(result)
  }
  
# Detecció de valors
  top250movies.detect <- function(value,
                                  pattern){
    if(is.na(value)){
      result <- NA
    }else{
      result <- grepl(pattern = pattern,
                      x = value)
    }
    return(result)
  }

# Valoració de la pel·lícula en termes de rendibilitat
  top250movies.is_profitable <- function(minimum_criteria){
    budget <- subset(x = top250movies,
                     select = Budget,
                     drop = TRUE)
    collection <- subset(x = top250movies,
                         select = Collection,
                        drop = TRUE)
    result <- collection-minimum_criteria*budget > 0
    return(result)
  }
  
# Normalització min-max
  top250movies.minmax_norm <- function(column){
    result <- (column - min(column))/(max(column) - min(column))
  }
```

## Eliminació de caràcters superflus

```{r}
# Title
  top250movies$Title <- top250movies.remove(column = 'Title',
                                            pattern = 'Original title:')

# Budget
  top250movies$Budget <- top250movies.remove(column = 'Budget',
                                             pattern = '\\(estimated\\)')
```

## Estandardització

S'observen els valors que pren la característica 'Classification'.

```{r}
# Classification
  top250movies$Classification <- factor(top250movies$Classification,
                                        levels = c('13',
                                                   '18',
                                                   '12',
                                                   'A',
                                                   '16',
                                                   '7',
                                                   'Apta para mayores',
                                                   'PG-13',
                                                   '(Banned)',
                                                   'PG',
                                                   'Passed',
                                                   '14',
                                                   'A/i',
                                                   'T',
                                                   'Not Rated',
                                                   '7/i'),
                                        labels = c('R',
                                                   'R',
                                                   'R',
                                                   'PG',
                                                   'R',
                                                   'PG-13',
                                                   'PG',
                                                   'PG-13',
                                                   'R',
                                                   'PG',
                                                   'PG',
                                                   'PG',
                                                   'PG',
                                                   'R',
                                                   'PG'),
                                        exclude = 'Not Rated')

# Collection
  top250movies$Collection <- top250movies.remove(column = 'Collection',
                                                 pattern = '[^0-9]')

# Gestió d'espais
  top250movies <- as.data.frame(apply(X = top250movies,
                                      MARGIN = c(1,2),
                                      FUN = str_trim,
                                      side = 'both'))
```

## Conversió

```{r}
# Duration
  top250movies$Duration <- mapply(FUN = top250movies.duration_conversion,
                                  duration = top250movies$Duration,
                                  USE.NAMES = FALSE)

# Review
  top250movies$Review <- mapply(FUN = top250movies.review_conversion,
                                review = top250movies$Review,
                                USE.NAMES = FALSE)
  
# Budget
  # Es defineix la política de conversió
  Monetary_conversion_policy <- data.frame('Local' = c('R$',
                                                       'FRF',
                                                       'DKK',
                                                       'DEM',
                                                       'A$',
                                                       '₹',
                                                       '€',
                                                       '₩',
                                                       '¥',
                                                       '£',
                                                       '$'),
                                           'Dolar' = c(0.055,
                                                       0.164261,
                                                       0.14,
                                                       0.0018,
                                                       0.66,
                                                       0.012,
                                                       1.08,
                                                       0.00073,
                                                       0.0064,
                                                       1.26,
                                                       1))
  
  top250movies$Budget <- mapply(FUN = top250movies.dollar_conversion,
                                monetary_units = top250movies$Budget,
                                USE.NAMES = FALSE)
```

## Canvi de tipus de dades

Es modifica la naturalesa dels atributs de la data.

```{r}
# Variables de caràcter enter
  for(i in c('Year', 'Duration', 'Review', 'Budget', 'Collection')){
    top250movies[[i]] <- as.integer(top250movies[[i]])
  }

# Variables de caràcter flotant
  top250movies$Rating <- as.numeric(top250movies$Rating)

# Variables de caràcter factor
  for(i in c('Classification', 'Director')){
    top250movies[[i]] <- as.factor(top250movies[[i]])
  }
```

## Transformacions dicotòmiques

```{r}
# Genre
  genre_list <- unique(str_trim(unlist(strsplit(top250movies$Genre,
                                               split = ','))))
  genre_list <- genre_list[!is.na(genre_list)]
  
  for(i in genre_list){
    top250movies[[paste('Is_',
                     i,
                     sep = '')]] <-
      mapply(FUN = top250movies.detect,
             value = top250movies$Genre,
             pattern = i,
             USE.NAMES = FALSE)
  }
```

## Valors extrems

Es cerquen i suprimeixen valors extrems per a les variables Budget i Collection. Totes les altres variables de caràcter numèric es consideren que contenen valors legítims.

```{r}
for(i in colnames(top250movies)){
  if(i %in% c('Budget', 'Collection')){
    outlier <- boxplot(top250movies[[i]])$out
    top250movies[[i]][top250movies[[i]] %in% outlier] <- NA}
  }
```

## Imputació

Primerament es cerca la proporció de valors perduts per característica.

```{r}
for(column in colnames(top250movies)){
  top250movies.na_prop(column)
}
```

S'adverteix que la proporció de valors perduts no supera en cap cas el 19%. Per tant es procedeix amb la imputació per k-NN considerant només el gènere, l'any, el rating i el review. 

```{r}
# Imputació per k-NN
  for(i in colnames(top250movies)){
    if(anyNA(top250movies[[i]])){
      top250movies <- kNN(data = top250movies,
                          variable = i,
                          metric = 'grower',
                          dist_var = c('Is_Drama',
                                       'Is_Crime',
                                       'Is_Action',
                                       'Is_Biography',
                                       'Is_History',
                                       'Is_Adventure',
                                       'Is_Western',
                                       'Is_Romance',
                                       'Is_Sci-Fi',
                                       'Is_Fantasy',
                                       'Is_Mystery',
                                       'Is_Family',
                                       'Is_Thriller',
                                       'Is_War',
                                       'Is_Comedy',
                                       'Is_Animation',
                                       'Is_Music',
                                       'Is_Horror',
                                       'Is_Film-Noir',
                                       'Is_Musical',
                                       'Is_Sport',
                                       'Year',
                                       'Rating',
                                       'Review'),
                          imp_var = FALSE)
    }
  }
```

## Generació de noves característiques

```{r}
# S'obtenen els beneficis per a cada pel·lícula
  top250movies$Net_income <- top250movies$Collection - top250movies$Budget

# Es comprova si la pel·lícula és rendible
  top250movies$Profitable <- top250movies.is_profitable(2)
```

## Normalització min-max d'atrbiuts numèrics

Es normalitzen els valors de les característiques numèriques en top250movies d'acord al criteri min-max.

```{r}
for(i in colnames(top250movies)){
  if(class(top250movies[[i]]) %in% c('numeric', 'integer') &
     i != 'Year'){
    top250movies[[i]] <- top250movies.minmax_norm(top250movies[[i]])
  }
}
```

