---
title: 'Tipologia i cicle de vida de les dades: pràctica 2'
author: "Eric Farran Moreno i Jordi Alvarez Pitarque"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    number_sections: yes
    toc_depth: 3
header-includes:
  \usepackage{dcolumn}
lang: ca
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
options(scipen = 999)
```

```{r}
# Es carreguen les llibreries requerides
  if (!require(stringr)) {
    install.packages('stringr')
  }
  library(stringr)

  if (!require(VIM)) {
    install.packages('VIM')
  }
  library(VIM)

  if (!require(ggplot2)) {
    install.packages('ggplot2')
  }
  library(ggplot2)

  if (!require(ggsats)) {
    install.packages('ggstats')
  }
  library(ggstats)
```

\newpage

# Importació dataset

```{r}
# S'importa la data
  top250movies <- read.csv('top250movies.csv')
```

# Neteja

## Definició de les funcions de neteja

```{r}
# Eliminació de patrons
  top250movies.remove <- function(column,
                                  pattern){
    input <- top250movies[[column]]
    result <- str_remove_all(string = input,
                             pattern = pattern)
    return(result)
  }

# Conversió del temps
  top250movies.time_conversion <- function(column){
    input <- top250movies[[column]]
    time <- c()
    for (i in 1:length(input)) {
      value <- str_split(string = input[i],
                         pattern = ' ')[[1]]
      hours <- 0
      minutes <- 0
      if (is.na(value[2])) {
        if (grepl(pattern = 'h',
                  x = value[1])) {
          hours <- as.numeric(str_remove_all(string = value[1],
                                             pattern = '[a-z]'))
          }else{
            minutes <- as.numeric(str_remove_all(string = value[1],
                                                 pattern = '[a-z]'))
            }
        }else{
          hours <- as.numeric(str_remove_all(string = value[1],
                                             pattern = '[a-z]'))
          minutes <- as.numeric(str_remove_all(string = value[2],
                                             pattern = '[a-z]'))
          }
      time[i] <- hours*60 + minutes
      }
    return(time)
    }

# Conversió d'unitats
  top250movies.units_conversion <- function(column){
    input <- top250movies[[column]]
    ifelse(test = grepl(pattern = 'K',
                        x = input),
           yes = units <- paste(str_remove_all(string = input,
                                         pattern = '[^0-9]'),
                                '000',
                                sep = ''),
           no = ifelse(test = grepl(pattern = '\\.',
                                    x = input),
                       yes = units <- paste(str_remove_all(string = input,
                                                           pattern = '[^0-9]'),
                                            '00000',
                                            sep = ''),
                       no = units <- paste(str_remove_all(string = input,
                                                          pattern = '[^0-9]'),
                                           '000000',
                                           sep = '')))
    return(units)
  }

# Conversió d'unitats monetàries
  top250movies.dollar_conversion <- function(column){
    input <- top250movies[[column]]
    conversion <- c()
    for (i in 1:length(input)) {
      ifelse(test = is.na(input[i]),
             yes = conversion[i] <- NA,
             no = conversion[i] <- subset(Monetary_conversion_policy,
                                          subset = Local == str_replace_all(string = input[i],
                                                                            pattern = '[0-9]',
                                                                            replacement = ''),
                                          select = Dolar,
                                          drop = TRUE) *
               as.numeric(str_replace_all(string = input[i],
                                          pattern = '[^0-9]',
                                          replacement = '')))
      }
    return(conversion)
    }

# Càlcul de la proporció de valors perduts
  top250movies.na_prop <- function(column){
    input <- top250movies[[column]]
    result <- cat(column,
               ': ',
               round(x = sum(is.na(input))/length(input),
                     digits = 3)*100,
               '%',
               '\n',
               sep = '')
    return(result)
  }
  
# Detecció de patrons
  top250movies.detect <- function(column,
                                  pattern){
    input <- top250movies[[column]]
    ifelse(test = is.na(input),
           yes = result <- NA,
           no = result <- as.numeric(grepl(pattern = pattern,
                                           x = input)))
    return(result)
  }

# Valoració en termes de rendibilitat
  top250movies.is_profitable <- function(minimum_criteria){
    budget <- top250movies[['Budget']]
    collection <- top250movies[['Collection']]
    result <- as.numeric(collection - minimum_criteria * budget > 0)
    return(result)
  }
  
# Normalització min-max
  top250movies.minmax_norm <- function(column){
    input <- top250movies[[column]]
    result <- (input - min(input))/(max(input) - min(input))
    return(result)
  }
```

## Eliminació de caràcters superflus

S'eliminen els caràcters no necessàris en les columnes del conjunt de dades.

```{r}
# Title
  top250movies$Title <- top250movies.remove(column = 'Title',
                                            pattern = 'Original title:')

# Budget
  top250movies$Budget <- top250movies.remove(column = 'Budget',
                                             pattern = '\\(estimated\\)|,|\\s')

# Collection
  top250movies$Collection <- top250movies.remove(column = 'Collection',
                                                 pattern = '[^0-9]')
```

## Estandardització

S'observen els valors que prenen cada característica en top250movies i s'estandaritzen sota una mateixa mesura.

```{r}
# Gestió d'espais
  top250movies <- as.data.frame(apply(X = top250movies,
                                      MARGIN = c(1,2),
                                      FUN = str_trim,
                                      side = 'both'))

# Classification
  top250movies$Classification <- factor(top250movies$Classification,
                                        levels = c('13',
                                                   '18',
                                                   '12',
                                                   'A',
                                                   '16',
                                                   '7',
                                                   'Apta para mayores',
                                                   'PG-13',
                                                   '(Banned)',
                                                   'PG',
                                                   'Passed',
                                                   '14',
                                                   'A/i',
                                                   'T',
                                                   'Not Rated',
                                                   '7/i'),
                                        labels = c('R',
                                                   'R',
                                                   'R',
                                                   'PG',
                                                   'R',
                                                   'PG-13',
                                                   'PG',
                                                   'PG-13',
                                                   'R',
                                                   'PG',
                                                   'PG',
                                                   'PG',
                                                   'PG',
                                                   'R',
                                                   'PG'),
                                        exclude = 'Not Rated')
```

## Conversió

S'expressen d'una mateixa manera els valors dels atributs requerits.

```{r}
# Duration
  top250movies$Duration <- top250movies.time_conversion(column = 'Duration')

# Review
  top250movies$Review <- top250movies.units_conversion(column = 'Review')
  
# Budget
  # Es defineix la política de conversió
  Monetary_conversion_policy <- data.frame('Local' = c('R$',
                                                       'FRF',
                                                       'DKK',
                                                       'DEM',
                                                       'A$',
                                                       '₹',
                                                       '€',
                                                       '₩',
                                                       '¥',
                                                       '£',
                                                       '$'),
                                           'Dolar' = c(0.055,
                                                       0.164261,
                                                       0.14,
                                                       0.0018,
                                                       0.66,
                                                       0.012,
                                                       1.08,
                                                       0.00073,
                                                       0.0064,
                                                       1.26,
                                                       1))
  
  top250movies$Budget <- top250movies.dollar_conversion(column = 'Budget')
```

## Canvi de tipus de dades

Es modifica la naturalesa dels atributs del conjunt de dades.

```{r}
for (column in colnames(top250movies)) {
  
  # Variables de tipus integer
    if (column %in% c('Year',
                      'Duration',
                      'Review',
                      'Budget',
                      'Collection')) {
      top250movies[[column]] <- as.integer(top250movies[[column]])
    }
  
  # Variables de tipus factor
    if (column %in% c('Classification',
                      'Director')) {
      top250movies[[column]] <- as.factor(top250movies[[column]])
    }
  
  # Variables de tipus numeric
    if (column == 'Rating') {
      top250movies[[column]] <- as.numeric(top250movies[[column]])
    }
  
}
```

## Valors extrems

Es cerquen i suprimeixen els valors extrems per a les variables Budget i Collection. Totes les altres variables de caràcter numèric, com per exemple 'Rating', es considera que contenen valors legítims.

```{r}
for (column in colnames(top250movies)) {
  if (column %in% c('Budget',
                    'Collection')) {
    outlier <- boxplot(top250movies[[column]])$out
    top250movies[[column]][top250movies[[column]] %in% outlier] <- NA}
  }
```

## Imputació

Primerament es cerca la proporció de valors perduts per a cada característica.

```{r}
for (column in colnames(top250movies)) {
  top250movies.na_prop(column = column)
}
```

S'adverteix que la proporció de valors perduts no supera en cap cas el 19%. Per tant es procedeix amb la imputació per k-NN considerant a la resta de dades disponibles. 

```{r}
# Imputació per k-NN
  for (column in colnames(top250movies)) {
    if (anyNA(top250movies[[column]])) {
      top250movies <- kNN(data = top250movies,
                          variable = column,
                          metric = 'grower',
                          imp_var = FALSE)
    }
  }
```

## Transformacions dicotòmiques

Es dicotomitza l'atribut 'Genre' i s'elimina la característica original.

```{r}
# Genre
  genre_list <- unique(str_trim(unlist(strsplit(top250movies$Genre,
                                               split = ','))))
  genre_list <- genre_list[!is.na(genre_list)]
  
  for (genre in genre_list) {
    top250movies[[paste('Is_',
                        genre,
                        sep = '')]] <- as.factor(top250movies.detect(column = 'Genre',
                                                                     pattern = genre))
  }
  
  top250movies <- subset(x = top250movies,
                         select = colnames(top250movies)[!(colnames(top250movies) %in% 'Genre')])
```

## Generació de noves característiques

En base a les dades ja existents, s'obté els beneficis de la pel·lícula i si és rendible només si 'Collection' és, almenys, 2 vegades superior a 'Budget'.

```{r}
# S'obtenen els beneficis per a cada pel·lícula
  top250movies$Net_income <- top250movies$Collection - top250movies$Budget

# Es comprova si la pel·lícula és rendible només si Collection és superior a 2 vegades Budget
  top250movies$Profitable <- as.factor(top250movies.is_profitable(minimum_criteria = 2))
```

## Exportació del conjunt de dades tractat

```{r}
# S'exporta el top250movies
write.csv(x = top250movies,
          file = 'dataset/top250movies_clean.csv')
```

# Contrast d'hipòtesi

Es vol estudiar si la proporció de pel·lícules rendibles és major quan el pressupost d'aquestes és superior a la mitjana, high, al 99% de confiança.

```{r, echo = FALSE}
# S'obté la taula
addmargins(table(top250movies$Profitable, factor(x = top250movies$Budget >= mean(top250movies$Budget),
                                                 levels = c(FALSE, TRUE),
                                                 labels = c('Low', 'High')),
                 dnn = c('Profitable', 'High budget')))

# Es grafica el constrast
ggplot(data = top250movies,
       aes(x = Budget > mean(Budget),
           fill = Profitable,
           by = Budget > mean(Budget))) +
  stat_count(geom = 'bar',
             position = 'stack') +
  geom_text(stat = 'prop',
            position = position_stack(vjust = 0.5)) +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
  scale_x_discrete(labels = c('Low', 'High')) +
  labs(title = 'Profitable movies proportion by budget',
       x = 'Budget',
       y = element_blank())
```

## Hipòtesi nul·la i alternativa

$H_{0}: \frac{p_{1}}{p_{2}} = 1$

$H_{1}: \frac{p_{1}}{p_{2}} > 1$

$p_{1} :=
\text{proporció problacional de pel·lícules rendibles amb pressupost superior o igual a la mitjana mostral}$

$p_{2} :=
\text{proporció problacional de pel·lícules rendibles amb pressupost inferior a la mitjana mostral}$

## Test estadístic

El test que s'empra en aquest apartat és el contrast de la proporció, o el contrast de dades categòriques, de dues mostres per a la cua superior on es compleix que, sota $H_{0}$:

$$
x^{2\space*} = \sum_{i}\sum_{j} \frac{(| O_{ij} - E_{ij} | - 0.5)^2}{E_{ij}} \sim X^{2}_{1}
$$

## Contrast

```{r}
# Es defineix la funció de filtrartge per a simplificar el procés
  top250movies.filter <- function(column,
                                  threshold,
                                  operator,
                                  show){
    input <- top250movies[[column]]
    value <- do.call(threshold, list(input))
    subset <- do.call(operator, list(input, value))
    result <- subset(x = top250movies,
                     subset = subset,
                     select = show,
                     drop = TRUE)
    return(result)
  }

# Es calculen els paràmetres
  group_1 <- top250movies.filter(column = 'Budget',
                                 threshold = 'mean',
                                 operator = '>=',
                                 show = 'Profitable')
  group_2 <- top250movies.filter(column = 'Budget',
                                 threshold = 'mean',
                                 operator = '<',
                                 show = 'Profitable')
  
  x_1 <- sum(as.numeric(group_1) - 1)
  x_2 <- sum(as.numeric(group_2) - 1)
            
  n_1 <- length(group_1)
  n_2 <- length(group_2)

# Es calcula el test
  test <- prop.test(x = c(x_1, x_2),
                    n = c(n_1, n_2),
                    alternative = 'greater',
                    conf.level = 0.99)
  
# S'obté el valor estimat
  x2 <- test$statistic[[1]]
```

```{r, echo = FALSE}
f2 <- function(x){
  y <- dchisq(x,
              df = 1)
  y[x < qchisq(p = 0.01,
               df = 1,
               lower.tail = FALSE)] <- NA
  return(y)
}

ggplot(data.frame(x = c(0, 12)),
       aes(x = x)) +
  stat_function(fun = f2,
                geom = 'area',
                fill = 'red') +
  stat_function(fun = dchisq,
                args = list(df = 1)) +
  geom_point(aes(x = x2,
                 y = 0),
             color = 'blue') +
    geom_text(aes(x = 8,
                  y = -0.05,
                  color = 'red'),
              label = '-> Rejection zone',
              show.legend = FALSE) +
  geom_text(aes(x = x2,
                y = -0.05),
            label = 'x2*') +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(title = 'Chi squared test',
       y = 'Probability',
       x = 'x')
```

## Interpretació

El resultat obtingut permet rebutjar $H_{0}$ amb $\alpha = 0.01$.

S'observa en el gràfic que $x^{2\space*}$ és troba situat dins la zona de rebuig, és a dir, que és superior al valor crític en aquest cas particular i, en conseqüència, amb les dades disponibles, es demostra estadísticament que la proporció de pel·lícules rendibles és major en el conjunt de metratges que sobrepassen el pressupost promig respecte a les altres.